<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <title>å°ç£äº’å‹•åœ°åœ–ï¼ˆé»ç¸£å¸‚é¡¯ç¤ºé„‰é®ï¼‰</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        #map {
            width: 600px;
            height: 600px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
        }

        button {
            padding: 6px 12px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h2>å°ç£ç¸£å¸‚äº’å‹•åœ°åœ–ï¼ˆé»ç¸£å¸‚é¡¯ç¤ºé„‰é®ï¼‰</h2>
    <div id="map"></div>
    <button onclick="resetMap()">ğŸ”„ å›åˆ°å…¨å°è¦–è§’</button>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let citydata = null;
        let towndata = null;
        let activeLayer = null;
        let townshipLayer = null;

        const map = L.map('map', {
            center: [23.7, 121],
            zoom: 7,
            dragging: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            boxZoom: false,
            keyboard: false,
            zoomControl: false,
            touchZoom: false
        });

        L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.jpg', {
            attribution: 'Â© OpenStreetMap è²¢ç»è€…'
        }).addTo(map);

        // é„‰é®åœ–å±¤å…ˆå»ºç«‹ç©ºå®¹å™¨
        townshipLayer = L.geoJSON(null, {
            onEachFeature: (feature, layer) => {
                const town = feature.properties.town || "æœªçŸ¥é„‰é®";
                layer.bindPopup(`é„‰é®ï¼š${town}`);

                layer.on('click', () => {
                    townshipLayer.resetStyle(); // æ¸…é™¤å…¶ä»–é«˜äº®
                    layer.setStyle({
                        fillColor: "orange",
                        fillOpacity: 0.8
                    });
                    layer.bringToFront();
                });
            },
            style: {
                color: "#888",
                weight: 1,
                fillColor: "#b2e2f2",
                fillOpacity: 0.4
            }
        }).addTo(map);

        const countyLayer = L.geoJSON(null, {
            onEachFeature: (feature, layer) => {
                const name = feature.properties.county || "æœªçŸ¥ç¸£å¸‚";
                layer.bindPopup(`ç¸£å¸‚ï¼š${name}`);

                layer.on('click', () => {
                    const selectedCounty = feature.properties.county;


                    // é«˜äº®ç›®å‰é»é¸çš„ç¸£å¸‚
                    if (activeLayer) {
                        countyLayer.resetStyle(activeLayer);
                        specialcountyLayer.resetStyle(activeLayer); // âœ… åŒæ™‚ reset ç‰¹æ®Šåœ–å±¤
                    }
                    layer.setStyle({ fillColor: "#ffcc00", fillOpacity: 0.9 });
                    layer.bringToFront();
                    activeLayer = layer;


                    // èšç„¦
                    if (selectedCounty === 'é«˜é›„å¸‚') {
                        map.setView([22.83, 120.3], 9); // é«˜é›„å¸‚çš„ä¸­å¿ƒé»èˆ‡é©ç•¶ zoom
                    } else {
                        map.fitBounds(layer.getBounds(), { maxZoom: 10 });
                    }


                    // é¡¯ç¤ºé„‰é®
                    showTownshipsByCounty(selectedCounty);
                });
            },
            style: {
                color: "#555",
                weight: 1,
                fillColor: "#99ccff",
                fillOpacity: 0.3
            }
        }).addTo(map);

        const specialcountyLayer = L.geoJSON(null, {
            onEachFeature: (feature, layer) => {
                const name = feature.properties.county || "æœªçŸ¥ç¸£å¸‚";
                layer.bindPopup(`ç¸£å¸‚ï¼š${name}`);

                layer.on('click', () => {
                    const selectedCounty = feature.properties.county;


                    // é«˜äº®ç›®å‰é»é¸çš„ç¸£å¸‚
                    if (activeLayer) {
                        countyLayer.resetStyle(activeLayer);
                        specialcountyLayer.resetStyle(activeLayer); // âœ… åŒæ™‚ reset ç‰¹æ®Šåœ–å±¤
                    }
                    layer.setStyle({ fillColor: "#ffcc00", fillOpacity: 0.9 });
                    layer.bringToFront();
                    activeLayer = layer;


                    // èšç„¦
                    if (selectedCounty === 'é«˜é›„å¸‚') {
                        map.setView([22.83, 120.3], 9); // é«˜é›„å¸‚çš„ä¸­å¿ƒé»èˆ‡é©ç•¶ zoom
                    } else {
                        map.fitBounds(layer.getBounds(), { maxZoom: 10 });
                    }


                    // é¡¯ç¤ºé„‰é®
                    showTownshipsByCounty(selectedCounty);
                });
            },
            style: {
                color: "#555",
                weight: 1,
                fillColor: "#99ccff",
                fillOpacity: 0.3
            }
        }).addTo(map);
        function resetMap() {
            if (activeLayer) {
                countyLayer.resetStyle(activeLayer);
                specialcountyLayer.resetStyle(activeLayer); // âœ… åŠ ä¸Šé€™è¡Œ
                activeLayer = null;
            }
            townshipLayer.clearLayers();
            map.setView([23.7, 121], 7);
        }


        function showTownshipsByCounty(countyName) {
            if (!towndata) return;
            const filtered = towndata.features.filter(f => f.properties.town.startsWith(countyName));
            townshipLayer.clearLayers();
            townshipLayer.addData(filtered);
        }

        // è¼‰å…¥ç¸£å¸‚è³‡æ–™ï¼ˆå°åŒ—å¸‚æœ€å¾ŒåŠ ï¼‰
        fetch('taiwan_counties.geojson')
            .then(res => res.json())
            .then(data => {
                const reordered = [
                    ...data.features.filter(f =>
                        !['è‡ºåŒ—å¸‚', 'å˜‰ç¾©å¸‚'].includes(f.properties.county)
                    ),
                ];
                const spcrecorded = [
                    ...data.features.filter(f => ['è‡ºåŒ—å¸‚', 'å˜‰ç¾©å¸‚'].includes(f.properties.county))
                ]
                citydata = { ...data, features: reordered };
                specialcountyLayer.addData(spcrecorded)
                countyLayer.addData(reordered);
            });

        // è¼‰å…¥é„‰é®è³‡æ–™ä¸€æ¬¡å‚™å¥½
        fetch('taiwan_townships.geojson')
            .then(res => res.json())
            .then(data => {
                towndata = data;
            });
    </script>
</body>

</html>